<!--
  APIM Resolver Policy for trade_monthly_by_code_countries
  對應 MCP Tool: query_trade_monthly_by_code

  按 HS Code 與國家分組的月度貿易統計資料。
  提供細到單一 HS Code 層級的月度統計，是最常用的貿易數據查詢工具。

  方案 A (推薦): Pass-through — 與現行 MCP tools (inline arguments) 相容
  方案 B (備用): Variables 模式 — 需修改 tools 送 variables 才能使用
-->

<!-- ============================================================ -->
<!-- 方案 A (推薦): Pass-through — 直接轉發 client query 到 Fabric  -->
<!-- ============================================================ -->
<http-data-source>
    <http-request>
        <set-backend-service backend-id="fabric-graphql-backend" />
        <set-method>POST</set-method>
        <set-url>@($"https://{{graphqlapi-trade-query-host}}/v1/workspaces/{{graphqlapi-trade-query-wkspace}}/graphqlapis/{{graphqlapi-trade-query-api}}/graphql")</set-url>
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
            // 直接轉發 client 的 GraphQL request body（含 inline arguments）
            return context.Request.Body.As<string>(preserveContent: true);
        }</set-body>
    </http-request>
</http-data-source>

<!-- ============================================================ -->
<!-- 方案 B (備用): Variables 模式 — 從 variables 讀取參數          -->
<!-- ============================================================ -->
<!--
<http-data-source>
    <http-request>
        <set-backend-service backend-id="fabric-graphql-backend" />
        <set-method>POST</set-method>
        <set-url>@($"https://{{graphqlapi-trade-query-host}}/v1/workspaces/{{graphqlapi-trade-query-wkspace}}/graphqlapis/{{graphqlapi-trade-query-api}}/graphql")</set-url>
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
    var incoming = context.Request.Body.As<JObject>() ?? new JObject();
    var vars = incoming["variables"] as JObject ?? new JObject();

    var payload = new JObject();

    payload["query"] = @"
        query (
          $first: Int
          $after: String
          $filter: trade_monthly_by_code_countryFilterInput
          $orderBy: trade_monthly_by_code_countryOrderByInput
        ) {
          trade_monthly_by_code_countries(
            first: $first
            after: $after
            filter: $filter
            orderBy: $orderBy
          ) {
            items {
              PERIOD_MONTH
              YEAR
              MONTH
              TRADE_FLOW
              HS_CODE
              HS_CODE_ZH
              COUNTRY_ID
              COUNTRY_COMM_ZH
              TRADE_VALUE_USD_AMT
              TRADE_VALUE_TWD_AMT
              TRADE_WEIGHT
              TRADE_QUANT
              UNIT_PRICE_USD_PER_KG
              ETL_DT
            }
            endCursor
            hasNextPage
          }
        }
    ";

    var variables = new JObject
    {
        ["first"] = vars["first"]?.Type == JTokenType.Integer
            ? vars["first"]
            : 50,
        ["after"] = vars["after"],
        ["filter"] = vars["filter"],
        ["orderBy"] = vars["orderBy"]
    };

    payload["variables"] = variables;

    return payload.ToString();
}</set-body>
    </http-request>
</http-data-source>
-->
