<!--
  APIM Resolver Policy for tXN_MOF_NON_PROTECT_MTs
  對應 MCP Tool: query_trade_transactions

  完整交易明細資料表。
  包含每筆進出口交易的完整資訊，資料量極大。
  獨有欄位: HS_CODE_EN, COUNTRY_EN, RATE_VALUE, TRADE_WEIGHT_ORG

  使用 context.GraphQL.Arguments 讀取 APIM 已解析的引數，
  再用標準 $variable definitions 送往 Fabric backend。
  GraphQLArguments 在 key 不存在時會拋例外，必須用 try/catch。
-->

<http-data-source>
    <http-request>
        <set-backend-service backend-id="fabric-graphql-backend" />
        <set-method>POST</set-method>
        <set-url>@($"https://{{graphqlapi-trade-query-host}}/v1/workspaces/{{graphqlapi-trade-query-wkspace}}/graphqlapis/{{graphqlapi-trade-query-api}}/graphql")</set-url>
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
    var args = context.GraphQL.Arguments;

    int first = 50;
    string after = null;
    JToken filter = null;
    JToken orderBy = null;

    try { first   = (int)args["first"];                  } catch {}
    try { after   = (string)args["after"];                } catch {}
    try { filter  = JToken.FromObject(args["filter"]);   } catch {}
    try { orderBy = JToken.FromObject(args["orderBy"]);  } catch {}

    var variables = new JObject
    {
        ["first"]   = first,
        ["after"]   = after,
        ["filter"]  = filter,
        ["orderBy"] = orderBy
    };

    var payload = new JObject
    {
        ["query"] = @"
            query (
              $first: Int
              $after: String
              $filter: TXN_MOF_NON_PROTECT_MTFilterInput
              $orderBy: TXN_MOF_NON_PROTECT_MTOrderByInput
            ) {
              tXN_MOF_NON_PROTECT_MTs(
                first: $first
                after: $after
                filter: $filter
                orderBy: $orderBy
              ) {
                items {
                  TXN_DT
                  HS_CODE
                  HS_CODE_ZH
                  HS_CODE_EN
                  COUNTRY_ID
                  COUNTRY_ZH
                  COUNTRY_EN
                  COUNTRY_COMM_ZH
                  COUNTRY_COMM_EN
                  TRADE_FLOW
                  TRADE_VALUE_TWD_AMT
                  TRADE_QUANT
                  TRADE_WEIGHT_ORG
                  TRADE_WEIGHT
                  RATE_VALUE
                  TRADE_VALUE_USD_AMT
                  ETL_DT
                }
                endCursor
                hasNextPage
              }
            }",
        ["variables"] = variables
    };

    return payload.ToString();
}</set-body>
    </http-request>
</http-data-source>
