<!--
  APIM Resolver Policy for tXN_MOF_NON_PROTECT_MTs
  對應 MCP Tool: query_trade_transactions

  完整交易明細資料表。
  包含每筆進出口交易的完整資訊，資料量極大。
  獨有欄位: HS_CODE_EN, COUNTRY_EN, RATE_VALUE, TRADE_WEIGHT_ORG

  ⚠️ 注意: 此表資料量非常大，建議在 APIM policy 層加入
  first 上限限制（如最大 500），避免單次查詢回傳過多資料導致 timeout。

  方案 A (推薦): Pass-through — 與現行 MCP tools (inline arguments) 相容
  方案 B (備用): Variables 模式 — 需修改 tools 送 variables 才能使用
-->

<!-- ============================================================ -->
<!-- 方案 A (推薦): Pass-through — 直接轉發 client query 到 Fabric  -->
<!-- ============================================================ -->
<http-data-source>
    <http-request>
        <set-backend-service backend-id="fabric-graphql-backend" />
        <set-method>POST</set-method>
        <set-url>@($"https://{{graphqlapi-trade-query-host}}/v1/workspaces/{{graphqlapi-trade-query-wkspace}}/graphqlapis/{{graphqlapi-trade-query-api}}/graphql")</set-url>
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
            // 直接轉發 client 的 GraphQL request body（含 inline arguments）
            return context.Request.Body.As<string>(preserveContent: true);
        }</set-body>
    </http-request>
</http-data-source>

<!-- ============================================================ -->
<!-- 方案 B (備用): Variables 模式 — 從 variables 讀取參數          -->
<!-- ============================================================ -->
<!--
<http-data-source>
    <http-request>
        <set-backend-service backend-id="fabric-graphql-backend" />
        <set-method>POST</set-method>
        <set-url>@($"https://{{graphqlapi-trade-query-host}}/v1/workspaces/{{graphqlapi-trade-query-wkspace}}/graphqlapis/{{graphqlapi-trade-query-api}}/graphql")</set-url>
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
    var incoming = context.Request.Body.As<JObject>() ?? new JObject();
    var vars = incoming["variables"] as JObject ?? new JObject();

    var payload = new JObject();

    payload["query"] = @"
        query (
          $first: Int
          $after: String
          $filter: TXN_MOF_NON_PROTECT_MTFilterInput
          $orderBy: TXN_MOF_NON_PROTECT_MTOrderByInput
        ) {
          tXN_MOF_NON_PROTECT_MTs(
            first: $first
            after: $after
            filter: $filter
            orderBy: $orderBy
          ) {
            items {
              TXN_DT
              HS_CODE
              HS_CODE_ZH
              HS_CODE_EN
              COUNTRY_ID
              COUNTRY_ZH
              COUNTRY_EN
              COUNTRY_COMM_ZH
              COUNTRY_COMM_EN
              TRADE_FLOW
              TRADE_VALUE_TWD_AMT
              TRADE_QUANT
              TRADE_WEIGHT_ORG
              TRADE_WEIGHT
              RATE_VALUE
              TRADE_VALUE_USD_AMT
              ETL_DT
            }
            endCursor
            hasNextPage
          }
        }
    ";

    var variables = new JObject
    {
        ["first"] = vars["first"]?.Type == JTokenType.Integer
            ? vars["first"]
            : 50,
        ["after"] = vars["after"],
        ["filter"] = vars["filter"],
        ["orderBy"] = vars["orderBy"]
    };

    payload["variables"] = variables;

    return payload.ToString();
}</set-body>
    </http-request>
</http-data-source>
-->
